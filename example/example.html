<!DOCTYPE html>
<html>
<head>
	<title>Demo Example</title>
	<script src='js/index.js'></script>
	<script>
		const defaultIntegrationType = 'study';
		const viewerCommunication = new ViewerCommunication('http://localhost:8080', defaultIntegrationType);
		viewerCommunication.subscribeCommunicationServiceReadyEvent(onCommunicationServiceReady);
		viewerCommunication.subscribeGetOpenedStudiesEvent(onGetDataCallback);
		viewerCommunication.subscribeGetViewportDataEvent(onGetDataCallback);
		viewerCommunication.subscribeGetViewportsInformationEvent(onGetDataCallback);
		viewerCommunication.subscribeGetSnapshotEvent(onGetSnapshot);

		function onOpeningTypeChange () {
			const openingType = document.getElementById('openingType').value;
			const windowIntegrationContainer = document.getElementById('windowIntegrationContainer');
			const iframeIntegrationContainer = document.getElementById('iframeIntegrationContainer');
			if (openingType === 'window') {
				windowIntegrationContainer.style.display = 'block';
				iframeIntegrationContainer.style.display = 'none';
			} else {
				iframeIntegrationContainer.style.display = 'block';
				windowIntegrationContainer.style.display = 'none';
			}
		}

		function onIntegrationTypeChange () {
			const integrationType = document.getElementById('integrationType').value;
			const studySelectionContainer = document.getElementById('studySelectionContainer');
			const studyIntegrationContainer = document.getElementById('studyIntegrationContainer');
			const tokenSelectionContainer = document.getElementById('tokenSelectionContainer');
			const tokenIntegrationContainer = document.getElementById('tokenIntegrationContainer');
			if (integrationType === 'study') {
				studySelectionContainer.style.display = 'block';
				studyIntegrationContainer.style.display = 'block';
				tokenSelectionContainer.style.display = 'none';
				tokenIntegrationContainer.style.display = 'none';
			} else {
				tokenSelectionContainer.style.display = 'block';
				tokenIntegrationContainer.style.display = 'block';
				studySelectionContainer.style.display = 'none';
				studyIntegrationContainer.style.display = 'none';
			}
			viewerCommunication.updateIntegrationType(integrationType);
		}

		function getSelectedStudyUid () {
			return document.getElementById('studySelection').value;
		}

		function getSelectedToken () {
			return document.getElementById('tokenSelection').value;
		}

		function getSelectedValueByIntegrationType () {
			return viewerCommunication.getIntegrationType() === 'study' ? getSelectedStudyUid() : getSelectedToken();
		}

		function openInMedDreamWindow () {
			const selectedValue = getSelectedValueByIntegrationType();
			viewerCommunication.openInMedDreamWindow(selectedValue);
		}

		function addToMedDreamWindow () {
			const selectedValue = getSelectedValueByIntegrationType();
			viewerCommunication.addToMedDreamWindow(selectedValue);
		}

		function replaceInMedDreamWindow () {
			const selectedValue = getSelectedValueByIntegrationType();
			viewerCommunication.replaceInMedDreamWindow(selectedValue);
		}

		function openMedDreamToIframe () {
			const iframeId = 'medDreamIframe';
			const selectedValue = getSelectedValueByIntegrationType();
			viewerCommunication.openMedDreamToIframe(iframeId, selectedValue);
			const iframe = document.getElementById(iframeId);
			iframe.style.display = 'block';
		}

		function focusWindow () {
			viewerCommunication.focusWindow();
		}

		function openStudy () {
			const study = getSelectedStudyUid();
			viewerCommunication.openStudy(study);
		}

		function openStudies () {
			const studies = [
				'1.2.826.0.1.3680043.8.1055.1.20190219152017841.651455468.5334909',
				'1.2.840.113619.2.66.2158408118.16050010109105933.20000',
				'1.2.826.0.1.3680043.8.1055.1.20161012115812848.450575715.8637545',
				'1.2.840.113619.2.55.3.4271045733.996.1449464144.595'
			];
			viewerCommunication.openStudies(studies);
		}

		function openStudiesWithToken () {
			const token = getSelectedToken();
			viewerCommunication.openStudies(token);
		}

		function replaceOpenedStudies () {
			const studies = [
				'1.2.840.113619.2.55.3.4271045733.996.1449464144.595',
				'1.2.840.113619.2.66.2158408118.16050010109105933.20000'
			];
			viewerCommunication.replaceStudies(studies);
		}

		function replaceOpenedStudiesWithToken () {
			const token = getSelectedToken();
			viewerCommunication.replaceStudies(token);
		}

		function preloadStudies () {
			const studies = [
				'1.2.826.0.1.3680043.8.1055.1.20161012115812848.450575715.8637545',
				'1.2.840.113619.2.55.3.4271045733.996.1449464144.595'
			];
			viewerCommunication.preloadStudies(studies);
		}

		function preloadStudiesWithToken () {
			const token = getSelectedToken();
			viewerCommunication.preloadStudies(token);
		}

		function cacheStudies () {
			const studies = [
				{studyUid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.595', storageId: 'Orthanc'},
				{studyUid: '1.2.840.113619.2.66.2158408118.16050010109105933.20000', storageId: 'Orthanc'}
			];
			viewerCommunication.cacheStudies(studies);
		}

		function cacheStudiesWithToken () {
			const token = getSelectedToken();
			viewerCommunication.cacheStudies(token);
		}

		function cacheAllStudies () {
			viewerCommunication.cacheAllStudies();
		}

		function closeStudies () {
			const studies = [
				{studyUid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.595', storageId: 'Orthanc'},
				{studyUid: '1.2.840.113619.2.66.2158408118.16050010109105933.20000', storageId: 'Orthanc'}
			];
			viewerCommunication.closeStudies(studies);
		}

		function closeStudiesWithToken () {
			const token = getSelectedToken();
			viewerCommunication.closeStudies(token);
		}

		function closeAllStudies () {
			viewerCommunication.closeAllStudies();
		}

		function setLayout (columns, rows) {
			viewerCommunication.setLayout(columns, rows);
		}

		function openInstance () {
			const instanceUid = '1.2.840.113619.2.55.3.4271045733.996.1449464144.599.1';
			const viewportColumn = 2;
			const viewportRow = 1;
			const viewportActions = {
				windowing: 'AUTO',							//DEFAULT, AUTO, CUSTOM
				//customWindowing: {width: 2, center: 2},	//Use if custom windowing
				//rotation: 45,
				//verticalFlip: true,
				//horizontalFlip: true,
				//scale: 'CUSTOM',							//ORIGINAL, FIT_TO_SCREEN, CUSTOM
				//customScale: 0.5,							//Use if custom scale
				//alignment: 'CENTER'						//RIGHT, LEFT, CENTER
			};
			viewerCommunication.openInstance(instanceUid, viewportColumn, viewportRow, viewportActions);
		}

		function exportActiveInstance () {
			viewerCommunication.exportInstance();
		}

		function exportContainerInstance (viewportColumn, viewportRow) {
			viewerCommunication.exportInstance(viewportColumn, viewportRow);
		}

		function disableSegmentation () {
			const permissions = {
				boundingBoxView: false,
				boundingBox2dEdit: false,
				boundingBox3dEdit: false,
				boundingBoxInfo: false,
				freeDrawView: false,
				freeDrawEdit: false,
				smartPaintView: false,
				smartPaint2dEdit: false,
				smartPaint3dEdit: false,
				smartPaintInfo: false
			};
			viewerCommunication.updateSegmentationToolPermissions(permissions);
		}

		function enableSegmentation () {
			const permissions = {
				boundingBoxView: true,
				boundingBox2dEdit: true,
				boundingBox3dEdit: true,
				boundingBoxInfo: true,
				freeDrawView: true,
				freeDrawEdit: true,
				smartPaintView: true,
				smartPaint2dEdit: true,
				smartPaint3dEdit: true,
				smartPaintInfo: true
			};
			viewerCommunication.updateSegmentationToolPermissions(permissions);
		}

		function getSnapshot () {
			viewerCommunication.getSnapshot();
		}

		let layoutSnapshot = undefined;
		function onGetSnapshot (snapshot) {
			console.log(snapshot);
			layoutSnapshot = snapshot;
		}

		function setSnapshot () {
			viewerCommunication.setSnapshot(layoutSnapshot);
		}

		function getWindowReference () {
			console.log(viewerCommunication.getWindowReference());
		}

		let showInfoLabelsValue = true;
		function showInfoLabels () {
			showInfoLabelsValue = !showInfoLabelsValue;
			viewerCommunication.showInfoLabels(showInfoLabelsValue);
		}

		function setAdditionalTopInfoLabels () {
			const labelsExample = {
				// Study labels will be ignored because series have higher priority
				topLeftLabels: [
					{
						level: 'study',
						uid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.595',
						labels: ['example', 'left'],
						hideDicomLabels: false
					},
					{
						level: 'series',
						uid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.601',
						labels: ['series', 'label'],
						hideDicomLabels: false
					}
				],
				topRightLabels: [
					// Study labels will be ignored because series have higher priority
					{
						level: 'study',
						uid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.595',
						labels: ['right', 'label'],
						hideDicomLabels: true
					},
					{
						level: 'series',
						uid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.601',
						labels: ['patient', 'right'],
						hideDicomLabels: false
					}
				]
			}
			viewerCommunication.setAdditionalInfoLabels(labelsExample);
		}

		function generateInstanceMpr (containerId) {
			viewerCommunication.generateInstanceMpr(containerId);
		}
		function changeViewportOrientation (containerId, orientation) {
			viewerCommunication.changeViewportOrientation(containerId, orientation);
		}

		function createMeasurement () {
			const measurementData = {
				id: 'closed-polygon-1',
				type: 'closed-polygon',
				containerId: 'viewport-container-1-1',
				studyUid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.595__Orthanc',
				seriesUid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.595__1.2.840.113619.2.55.3.4271045733.996.1449464144.601__Orthanc',
				instanceUid: '1.2.840.113619.2.55.3.4271045733.996.1449464144.595__1.2.840.113619.2.55.3.4271045733.996.1449464144.601__1.2.840.113619.2.55.3.4271045733.996.1449464144.602.1__Orthanc',
				colors: {
					regularColor: '#FFA500',
					activeColor: '#33CCFF',
					markedColor: '#009BFF',
					activeLabelColor: '#FFF'
				},
				data: {
					points: [
						[-55.168894532260964, 32.4931972896166, 42.5],
						[12.520785835194232, -6.558543217479382, 42.5],
						[95.8311612584763, 37.179406120000635, 42.5],
						[-0.4964600446614611, 118.40702869925087, 42.5],
						[-55.168894532260964, 32.4931972896166, 42.5]
					]
				}
			}
			viewerCommunication.createNewMeasurement('viewport-container-1-1', measurementData);
		}

		function deleteMeasurement () {
			const measurementId = 'closed-polygon-1';
			viewerCommunication.deleteMeasurementById(measurementId);
		}

		function getData () {
			switch (document.getElementById('dataTypeSelection').value) {
				case 'openedStudies':
					viewerCommunication.getOpenedStudies();
					break;
				case 'viewportData':
					const showLabels = false;
					viewerCommunication.getViewportData(showLabels);
					break;
				case 'viewportsInformation':
					viewerCommunication.getViewportsInformation();
					break;
				default:
					break;
			}
		}

		function onGetDataCallback (studies) {
			console.log(studies);
		}

		function onCommunicationServiceReady () {
			console.log('Communication Service Ready');
		}

		function subscribeEvent () {
			switch (document.getElementById('eventSelection').value) {
				case 'studyLoaded':
					viewerCommunication.subscribeStudyLoadedEvent(this.onEventCallback);
					break;
				case 'annotationsSaved':
					viewerCommunication.subscribeAnnotationsSavedEvent(this.onEventCallback);
					break;
				case 'instanceChanged':
					viewerCommunication.subscribeInstanceChangedEvent(this.onEventCallback);
					break;
				case 'activeContainerChanged':
					viewerCommunication.subscribeActiveContainerChangedEvent(this.onEventCallback);
					break;
				case 'measurementCreated':
					viewerCommunication.subscribeMeasurementCreatedEvent(this.onEventCallback);
					break;
				case 'measurementUpdated':
					viewerCommunication.subscribeMeasurementUpdatedEvent(this.onEventCallback);
					break;
				default:
					break;
			}
		}

		function unsubscribeEvent () {
			switch (document.getElementById('eventSelection').value) {
				case 'studyLoaded':
					viewerCommunication.unsubscribeStudyLoadedEvent(this.onEventCallback);
					break;
				case 'annotationsSaved':
					viewerCommunication.unsubscribeAnnotationsSavedEvent(this.onEventCallback);
					break;
				case 'instanceChanged':
					viewerCommunication.unsubscribeInstanceChangedEvent(this.onEventCallback);
					break;
				case 'activeContainerChanged':
					viewerCommunication.unsubscribeActiveContainerChangedEvent(this.onEventCallback);
					break;
				case 'measurementCreated':
					viewerCommunication.unsubscribeMeasurementCreatedEvent(this.onEventCallback);
					break;
				case 'measurementUpdated':
					viewerCommunication.unsubscribeMeasurementUpdatedEvent(this.onEventCallback);
					break;
				default:
					break;
			}
		}

		function onEventCallback (data) {
			console.log(data);
		}

	</script>
</head>
<body>
	<div>
		<label for='openingType'>MedDream opening type:</label>
		<select id='openingType' onchange='onOpeningTypeChange()'>
			<option value='window'>Window</option>
			<option value='iframe'>Iframe</option>
		</select>
		<label for='integrationType'>MedDream integration type:</label>
		<select id='integrationType' onchange='onIntegrationTypeChange()'>
			<option value='study'>Study</option>
			<option value='token'>Token</option>
		</select>
	</div>
	<br>
	<div id='studySelectionContainer'>
		<label for='studySelection'>Choose a Study:</label>
		<select id='studySelection'>
			<option value='1.2.826.0.1.3680043.8.1055.1.20190219152017841.651455468.5334909'>1.2.826.0.1.3680043.8.1055.1.20190219152017841.651455468.5334909</option>
			<option value='1.2.840.113619.2.66.2158408118.16050010109105933.20000'>1.2.840.113619.2.66.2158408118.16050010109105933.20000</option>
			<option value='1.2.840.113619.2.55.3.4271045733.996.1449464144.595'>1.2.840.113619.2.55.3.4271045733.996.1449464144.595</option>
			<option value='1.2.826.0.1.3680043.8.1055.1.20161012115812848.450575715.8637545'>1.2.826.0.1.3680043.8.1055.1.20161012115812848.450575715.8637545</option>
		</select>
	</div>
	<div id='tokenSelectionContainer' style='display: none;'>
		<label for='tokenSelection'>Choose a Token:</label>
		<select id='tokenSelection'>
			<option value='PA2kdugjw3kQ9Mndbfoo1xfyou59xQAzK_H6GI9pvjjttdD0w460KTK2pR-Kg-W_XK3n6HcKpcS_fDn_DoQv8KPFynvPwAVULnWLYsuWN3hKrm8DBpI='>Token1</option>
			<option value='PA2kdugjw3kQ9Mndbfoo1xfyou55xQUyK_X_F49pvjjttdSlmNK0L2SypUeA2L2_XPHhundTpMS4fGupX4Et9a-UnSvMnnd-MUaFtW5PT3fzqkrgr14='>Token2</option>
			<option value='XNH8WmSy5Qwl430OgdXfBGeK4GfTOQZZAbflH4xzU8K6fkFaCNaNL0GQMFTQ7sNXlDPVPU9nhCxyAxwE9wUX1AiEtecydDhaTvjHbE1bOQo='>Token3</option>
		</select>
	</div>
	<br>
	<div id='windowIntegrationContainer'>
		<label>Window:</label>
		<button type='button' onclick='openInMedDreamWindow()'>Open in MedDream</button>
		<button type='button' onclick='addToMedDreamWindow()'>Add to MedDream</button>
		<button type='button' onclick='replaceInMedDreamWindow()'>Replace in MedDream</button>
		<button type='button' onclick='focusWindow()'>Focus MedDream</button>
	</div>
	<div id='iframeIntegrationContainer' style='display: none;'>
		<label>Iframe:</label>
		<button type='button' onclick='openMedDreamToIframe()'>Open MedDream to Iframe</button>
	</div>
	<br>
	<div id='studyIntegrationContainer'>
		<label>Study integration:</label>
		<button type='button' onclick='openStudy()'>Open study</button>
		<button type='button' onclick='openStudies()'>Open studies</button>
		<button type='button' onclick='replaceOpenedStudies()'>Replace opened studies</button>
		<button type='button' onclick='preloadStudies()'>Preload studies</button>
		<button type='button' onclick='cacheStudies()'>Cache studies</button>
		<button type='button' onclick='closeStudies()'>Close studies</button>
	</div>
	<div id='tokenIntegrationContainer' style='display: none;'>
		<label>Token integration:</label>
		<button type='button' onclick='openStudiesWithToken()'>Open studies</button>
		<button type='button' onclick='replaceOpenedStudiesWithToken()'>Replace opened studies</button>
		<button type='button' onclick='preloadStudiesWithToken()'>Preload studies</button>
		<button type='button' onclick='cacheStudiesWithToken()'>Cache studies</button>
		<button type='button' onclick='closeStudiesWithToken()'>Close studies</button>
	</div>
	<br>
	<div>
		<button type='button' onclick='cacheAllStudies()'>Cache all studies</button>
		<button type='button' onclick='closeAllStudies()'>Close all studies</button>
		<button type='button' onclick='setLayout(3, 3)'>Set layout 3x3</button>
		<button type='button' onclick='setLayout(2, 1)'>Set layout 2x1</button>
		<button type='button' onclick='setLayout(1, 2)'>Set layout 1x2</button>
	</div>
	<br>
	<div>
		<button type='button' onclick='openInstance()'>Open instance</button>
		<button type='button' onclick='exportActiveInstance()'>Export active instance</button>
		<button type='button' onclick='exportContainerInstance(2, 2)'>Export container 2:2 instance</button>
		<button type='button' onclick='disableSegmentation()'>Disable segmentation</button>
		<button type='button' onclick='enableSegmentation()'>Enable segmentation</button>
		<button type='button' onclick='getSnapshot()'>Get snapshot</button>
		<button type='button' onclick='setSnapshot()'>Set snapshot</button>
		<button type='button' onclick='getWindowReference()'>Get window reference</button>
	</div>
	<br>
	<div>
		<button type='button' onclick='showInfoLabels()'>Show/Hide info labels</button>
		<button type='button' onclick='setAdditionalTopInfoLabels()'>Set additional top info labels</button>
		<button type='button' onclick='generateInstanceMpr("viewport-container-1-1")'>Generate instance MPR</button>
		<button type='button' onclick='changeViewportOrientation("viewport-container-1-1", "AXIAL")'>Create MPR Axial</button>
		<button type='button' onclick='changeViewportOrientation("viewport-container-1-1", "SAGITTAL")'>Create MPR Sagittal</button>
		<button type='button' onclick='changeViewportOrientation("viewport-container-1-1", "CORONAL")'>Create MPR Coronal</button>
	</div>
	<br>
	<div>
		<button type='button' onclick='createMeasurement()'>Create measurement</button>
		<button type='button' onclick='deleteMeasurement()'>Delete measurement</button>
	</div>
	<br>
	<div>
		<label for='dataTypeSelection'>Data type:</label>
		<select id='dataTypeSelection'>
			<option value='openedStudies'>Opened studies</option>
			<option value='viewportData'>Viewport data</option>
			<option value='viewportsInformation'>Viewports information</option>
		</select>
		<button type='button' onclick='getData()'>Get data</button>
		<label for='eventSelection'>Event:</label>
		<select id='eventSelection'>
			<option value='studyLoaded'>Study loaded</option>
			<option value='annotationsSaved'>Annotations saved</option>
			<option value='instanceChanged'>Instance changed</option>
			<option value='activeContainerChanged'>Active container changed</option>
			<option value='measurementCreated'>Measurement created</option>
			<option value='measurementUpdated'>Measurement updated</option>
		</select>
		<button type='button' onclick='subscribeEvent()'>Subscribe</button>
		<button type='button' onclick='unsubscribeEvent()'>Unsubscribe</button>
	</div>
	<br>
	<iframe id='medDreamIframe' title='medDreamIframe' width='100%' height='550px' style='display: none;'></iframe>
</body>
</html>
